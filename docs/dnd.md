Как сделать dnd в дереве

Рисуешь обычным образом дерево. Далее, когда начинается dnd,
первое, что необходимо сделать это определить прямоугольники
для всех узлов. Далее, из этих прямоугольников необходимо
создать массив т.н. insertion points. Этот массив будет
использоваться для определения места вставки: при каждом
движении мыши нужно будет найти точку ближайшую к курсору.
Это и будет место вставки.

(1) Нарисовать дерево

    +--------+
    | colors |
    +---+-------+
        | red   |
        +-------+
        | green |
        +-------+
        | blue  |
    +---+-------+
    | shapes |
    +---+----------+
        | circle   |
        +----------+
        | square   |
        +----------+
        | triangle |
        +----------+

(2) Определить координаты прямоугольников

    +--------+ ................... 100
    | colors |
    +---+-------+  ............... 150
        | red   |
        +-------+  ............... 200
        | green |
        +-------+  ............... 250
        | blue  |
    +---+-------+  ............... 300
    | shapes |
    +---+----------+ ............. 350
        | circle   |
        +----------+ ............. 400
        | square   |
        +----------+ ............. 450
        | triangle |
        +----------+ ............. 500

(3) Определить insertion points

    o--------+ ................... 100
    | colors |
    +---o-------+  ............... 150
        | red   |
        o---o---+  ............... 200
        | green |
        o---o---+  ............... 250
        | blue  |
    o---o---o---+  ............... 300
    | shapes |
    +---o----------+ ............. 350
        | circle   |
        o---o------+ ............. 400
        | square   |
        o---o------+ ............. 450
        | triangle |
    o   o---o------+ ............. 500

    1--------+ ................... 100
    | colors |
    +---2-------+  ............... 150
        | red   |
        3---4---+  ............... 200
        | green |
        5---6---+  ............... 250
        | blue  |
    7---8---9---+  ............... 300
    | shapes |
    +---10---------+ ............. 350
        | circle   |
        11--12-----+ ............. 400
        | square   |
        13--14-----+ ............. 450
        | triangle |
    15  16--17-----+ ............. 500


1. before colors
2. before red
3. before green (after red)
4. last child of red
5. before blue (after green)
6. last child of green
7. before shapes (after colors)
8. after blue (last child of colors)
9. last child of blue
10. before circle
11. before square (after cicle)
12. last child of circle
13. before triangle (after square)
14. last child of square
15. after shapes
16. after triangle (last child of shapes)
17. last child of triangle

(4) При каждом движении мыши необходимо найти точку,
ближе всего расположенную к курсору. Это и будет
место вставки.
